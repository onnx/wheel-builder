env:
  global:
    - REPO_DIR=onnx
    - BUILD_COMMIT=994c6181247d7b419b28889fc57d5817e2089419
    - PLAT=x86_64
    - PB_VERSION=2.6.1
    - REPO=https://upload.pypi.org/legacy/
    - TEST_REPO=https://test.pypi.org/legacy/
    - secure: RHpB38w8azGMD1v6NkxuJO9x/eqOEON+IWcqNVjOweZYwNkupZvjissludvXgjli5ZJ9mHG3JQD0alZa2fQ8UX3FOi1hh7OQf+vrZ6ydRm2XOr53IGAuG2G9iTdBngDma9sK9QjvzHFSX922YO9VW12x66/Ht0sARUmJ5W1y/2srUFfwcS1MTbMHQc3rb33OnrOvmv/Xx8S0LHnKYTsdLNRzsbNKUyWyVi379BeuiQF1ROB0mh9zcpK93TjkI9PU5lWZKLjoZWSj++ZIOQoTohDdjecYPiicj6b2HykUqNWl8AFA5UgfiYmmMgbnHNMEHn/uCJSGqGtA4sH51uoYw70rR/vZIQF6dy1Wx1EPQv3Qwb0O/ME2VA1p6HtXtfdkahOqXmvFbnKRVEkNB5+7qXUaId/RQpVbWrE/StZCJhxMgynSbs9Tr7Iu/Pd57ZTnZuPZPv5lE83bVWwo/WFjRZwwE28NSBcME6Y7FPjdyTARWfeFvhhS0OimTD5jk0jIVW5yWrqIOtOVc7M/ZvWXcl0r77F8/CJ9bupwLX+rusXkQ+n52nt8i1BIERWbKSgsDBnvdzkDAJp9nYuhYngN46FZnI2UYXXJsmFLDF1T+L2szJTJ+ZTjRB7dK73tXl42qeo1z9TbSHQZcRIh4dRqqbb3oPDGiMvwsTkbl8uya84=
    - secure: eNcBc4erIqiXEhEtUNDAYRPgTCftDna88q5yryIsjpiYEgykm0K9ylY+L6nge8CwgwZipjsPyA43gKgV3pToD830qU32+U/C6xTJaaEiIfbQh8kW5AdOF5CE2T/N3CbgFhOBumQnxVTgZwfs9lI/KTHQHesErZ1gI/D1aaX3UAYd473dyQmsjkbUFJK5yTZ6Swh2xy4ao28DWgphSzwYiClIhBSjeCfOgJFI6o2tD1CbByNMqx+1WeK9pBvOgkNS5rigcMcAlRFOrPY8YnBueB2e7IEHHNtXH96uR0YWGA6aLl+o97nZ0kYH/V1yicCa/JE1/B5ZC0JPCMOw4xJbLXM87/yFbPgGNxm5DwXxMvF/dDiZpC1pubT2qn/6wpEDFPKqureSK9eilt95neLGMUC/QuyKiargejrJ9cXlsUhRx5f4YxfBmkSHCXtNQ+X62VMwBnfDEdPE7we/0OMShuRcENzfGfIfW2zVSX2px4QUQVX4I49GW43aEPWKj7x8OjxTT5r4aIeDjIe+blXuN3Cqjq1obBWusF+kH3yD564/XCi8gnozSY8hzbjCIVUSDf4fj7InzVk3HdLQOPmXRkQ9FjAgYbMnXWs71B2CDoJHu5319OSZXzlUGm9xCHtWqAnJLi4JhKMzN55Zat3R5JyuzGA28dv8qt9e8/dnvHc=
    - secure: pRolU0r+KbbC5o4uPrNAOF33SfpaQbcWKvzNJdZ9MXaJwivGcczmpDiYNIoEW8CWn8GOwll9fG8/3Fiwth8Sqyl8/ipJAjv57DAvoF8FlxuHxYNfCbatgzUJvH9OWrNzynvB5bXXl9oK87+mfzip9H7B4YG6y8guYa9fAQ1Lto5wdUfUrSDhKxiE9+KPQnu+nvG+9bHaTEgjeBe/os23e4MmHFcb1wqXGNhXLqiVtvUEQHKM0SdHS5AdTNsAxzAzs6NJFGKXKrLYJ1/+S8sT6BgIVDXbrhYHBnQgJpgRHvgiixe9cU2NM6lhb1NwrLwkDTbGIdnBBC6C378JsKHPIJ8tQrsGCW/zcmAAgMYnKjAE08ipAlXgbLTmMZxH5UqOvq9Y9nhw91CXa8ymtPt4PPvJZHI6MSL42/W0rQ/jdsFdEhLOAf4eI7r8WESaVC5dDM/GifzM9dCx6EzQKDYmnVXkF33B1EDp3lEv/mEiZRy56SWyp7NKduW8xE7otxPt0oufH5oJuIbkuPdfqxNPiQiaJqDjTOwKaBH8onhsDv5SO2OVPTLmrEvggWoMHeFzJbpxGRrVKqvoy9ipXTGjmy6WoFN8+Nxw5n84siEMWyHTrXCvD82gIgK4SKRyz32fy6EY6kP4zvCLOtSspajstw7eTRzd5KQ1Mxd/GKeFHG0=
    - secure: bB/mfE8dMPwW+G+ZAISfWqtIAekg1iEeexwj4XIA6mv2T33gqgXcDhl+jiU31EM0gHZG2URiL9QHNSQOdw6vVtl+sqks0JDvVW1F96mRWWKoLX4PekDCxQaRlFZ8/MQbH/t7+gtSn925NQW4LLVrnjIMpLAMnSOzg0GddC4ONdb3AQjm2WOafvcp1nERJfOvYSyojM5LqczAuy2Rj5dQaDvYl3iC2/FvauyTADYV/UMaCY4ajky1SSysccSTAEVSSw/pRyvWGH1e6Z9aX8n+bHLu5VKpaahVTxpHj2GQC1BpRQieIIT8nJ0zv2fPUV1rdWj5PT6zKF/pAuPYS7OBX9U8bEHRR97TaSAyorXVMGtuwCmG4Bzh8EAOmbAFuuuww7x285HhkjWKz3bxr5axeIFjv17nsEfR1OdTFHq/sy7KMwKWxxTjEfQjtbJic8W+SAdnTutyWegoFChr0EcW7HWOPMikyaO0nZ68wRJu+XbqP/B9bsK7bgElXEOqHAKcs+4OAEmiLZkNLBsetB/8PYGcHRrj2hn1WWNpNR47DAYXaoz4F338oKCFjQV8NuWEnd8RUWFp5irO7fK82U2hWPVgJsEsIJXLs79dNZEeQbmXQodF+9gEfM5hxCZFV2FvOqEyb1oFs1h7RlTDtgidht+sMfu+oh2tOfPg8Ci6MRo=
    - secure: yVC6mVMULmTls3yZIRnJ6/FENqpofx5pq2aXZGGTggMPVa2OEiBb06RFzde/yQzGKxGSj360fjB8lk990eupqJ85IOTvkY8puT+1ZX9ub4yIwnVAnXRog0fFSAJylPg6CMRAb/MjHkPkjpwKBAez+o6LvI6pCkXF1V131ogfSjPr9kEPAd4tZoH0AgnybZOxkdtpWLPZVc+YqR0G/AvUBXXHajWI1LB4msg9UtpwrK/8kkRiEBOrHJQ/Sw3IL4M/++7euyS8XeVpLMs+Ru+NHouvQFc7f9lRNnY2ZpRdso30FWXQLNz+4f/t8VwdGoZJFM5/FmNeoVDrcjsQRx4mrBkud89k4LhlK5qZ60XMJSU7sQf8059SUjrgTRHMl6kwkSNWprP1U2IavDY8VX/h30lD3RImlLHm8N0/aeSpAK9Fht5LmTGUzKsaniiu4uTRQlEr+s97eWu6kuhCPgdrFCs5WwTPR44dt1bFWFUVFv6LNXjLAmgomcluXHAeLEFJh9on9bQ5V0V33TwSktvxjNAxe0CqYgWnjHKzqzZOPUOY3ju16o5T8Yns9uHYIW+XpL1rj4vd/zbToqIRBsUWJSPfRNIrHxLk0TdIP71PfAEbu++c1gTIMDcrXuHc8+D+qQ4QyhiYRrIn9BVtA2ZUYUNOv6dsItd3AQeRhHgo3dM=
addons:
  artifacts:
    s3_region: "us-west-1" # defaults to "us-east-1"
    debug: true
    paths:
      - $(git ls-files -o | grep .whl |tr "\n" ":")
    target_paths:
      - /test

language: python
# Default Python version is usually 2.7
python: 3.5
sudo: required
dist: trusty
services: docker
# Force xcode 6.4 image to work round
# https://github.com/python-pillow/pillow-wheels/issues/45
# So we have the line below for OSX builds
# osx_image: xcode9.3beta
matrix:
  include:
  - name: "OSX Python 3.5"
    os: osx
    language: generic
    sudo: required
    osx_image: xcode9.3beta
    env:
      - MB_PYTHON_VERSION=3.5
      - ONNX_ML=1
      - MACOSX_DEPLOYMENT_TARGET=10.9
  - name: "OSX Python 3.6"
    os: osx
    language: generic
    sudo: required
    osx_image: xcode9.3beta
    env:
      - MB_PYTHON_VERSION=3.6
      - ONNX_ML=1
      - MACOSX_DEPLOYMENT_TARGET=10.9
  - name: "OSX Python 3.7"
    os: osx
    language: generic
    sudo: required
    osx_image: xcode9.3beta
    env:
      - MB_PYTHON_VERSION=3.7
      - ONNX_ML=1
      - MACOSX_DEPLOYMENT_TARGET=10.9
  - name: "OSX Python 3.8"
    os: osx
    language: generic
    sudo: required
    osx_image: xcode9.3beta
    env:
      - MB_PYTHON_VERSION=3.8
      - ONNX_ML=1
      - MACOSX_DEPLOYMENT_TARGET=10.9
  - name: "Linux x64 Python 3.5"
    os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=3.5
      - MB_ML_VER=2010
      - ONNX_ML=1
  - name: "Linux x64 Python 3.6"
    os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=3.6
      - MB_ML_VER=2010
      - ONNX_ML=1
  - name: "Linux x64 Python 3.7"
    os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=3.7
      - MB_ML_VER=2010
      - ONNX_ML=1
  - name: "Linux x64 Python 3.8"
    os: linux
    sudo: required
    env:
      - MB_PYTHON_VERSION=3.8
      - MB_ML_VER=2010
      - ONNX_ML=1
  - name: "Linux x86 Python 3.5"
    os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=3.5
      - MB_ML_VER=2010
      - ONNX_ML=1
      - PLAT=i686
  - name: "Linux x86 Python 3.6"
    os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=3.6
      - MB_ML_VER=2010
      - ONNX_ML=1
      - PLAT=i686
  - name: "Linux x86 Python 3.7"
    os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=3.7
      - MB_ML_VER=2010
      - ONNX_ML=1
      - PLAT=i686
  - name: "Linux x86 Python 3.8"
    os: linux
    sudo: required
    env:
      - MB_PYTHON_VERSION=3.8
      - MB_ML_VER=2010
      - ONNX_ML=1
      - PLAT=i686

before_install:
  - source multibuild/common_utils.sh;
  - source multibuild/travis_steps.sh;
  - before_install;

install:
  - clean_code $REPO_DIR $BUILD_COMMIT;
  - build_wheel $REPO_DIR $PLAT;

script:
  - install_run $PLAT

after_success:
- >
  if [[ $MB_PYTHON_VERSION == "3.5" && $TRAVIS_OS_NAME == "osx" ]]; then
    echo "Python 3.5 on Mac will fail while uploading PyPi package. Save the wheel to AWS anyway.";
  elif [ -n "$TRAVIS_TAG" ]; then
    pip install twine;
    pip install pyOpenSSL ndg-httpsclient pyasn1 || true;
    python -m twine upload --skip-existing ${TRAVIS_BUILD_DIR}/wheelhouse/*.whl --repository-url $REPO -u $PYPI_USERNAME_TRAVIS -p $PYPI_PASSWORD_TRAVIS ;
    echo "Deployed to PyPI.";
  elif [ "$TRAVIS_BRANCH" == "pypi-test" ]; then
    pip install twine;
    pip install pyOpenSSL ndg-httpsclient pyasn1 || true;
    ls ${TRAVIS_BUILD_DIR}/wheelhouse/;
    python -m twine upload --skip-existing ${TRAVIS_BUILD_DIR}/wheelhouse/*.whl --repository-url $TEST_REPO -u $PYPI_USERNAME -p $PYPI_PASSWORD ;
    echo "Deployed to test PyPI.";
  else
    echo "Not deploying as not a commit on test branch.";
  fi

cache:
- timeout: 300
- directories:
  - "$BUILD_CCACHE_DIR"
  - "$HOME/.ccache"
  - "$HOME/.cache/pb"
